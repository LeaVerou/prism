<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="utf-8" />
<link rel="shortcut icon" href="favicon.png" />
<title>Test drive â–² Prism</title>
<link rel="stylesheet" href="style.css" />
<link rel="stylesheet" href="themes/prism.css" data-noprefix />
<style>
#theme {
	margin-right: -9em;
}

textarea {
	width: 100%;
	height: 10em;
	padding: 1em;
	box-sizing: border-box;
	margin: .5em 0;
	background: #f5f2f0;
	color: black;
	text-shadow: 0 1px white;
	tab-size: 4;
	font: 100% Consolas, Monaco, monospace;
	white-space: pre;
	word-wrap: normal;
}

.list {
	column-count: 4;
}

	.list label {
		display: block;
		padding: .2em;
	}

	.list input {
		margin-right: 1em;
	}

	.list strong {
		display: block;
		column-span: all;
	}

#language label[data-id="javascript"] {
	border-bottom: 1px solid #aaa;
	padding-bottom: 1em;
	margin-bottom: 1em;
}

#plugins input {
	margin-right: 1em;
}

#options {
	column-count: 2;
}

#options input {
	width: 100%;
	font-size: 14px;
	box-sizing: border-box;
	padding: 0 5px;
}

#options input:focus{
	outline: none;
}

</style>
<script src="prefixfree.min.js"></script>

<script>var _gaq = [['_setAccount', 'UA-33746269-1'], ['_trackPageview']];</script>
<script src="http://www.google-analytics.com/ga.js" async></script>
</head>
<body>

<header>
	<div class="intro" data-src="templates/header-main.html" data-type="text/html"></div>

	<h2>Test drive</h2>
	<p>Take Prism for a spin!</p>
</header>

<section>
	<form>
		<p>
			<textarea>&lt;p class="hey">Type some code here&lt;/p></textarea>
		</p>

		<p id="language" class="list">
			<strong>Language:</strong>
		</p>

		<p id="plugins" class="list">
			<strong>Plugins:</strong>
		</p>

		<p id="options" class="list">
			<strong>Options:</strong>
			<input type="text" name="codeClass" placeholder="Class name (e.g.: line-numbers)">
			<input type="text" name="codeAttributes" placeholder="Attributes (e.g.: data-count='10')">
		</p>

		<p>Result:</p>
		<pre><code></code></pre>
	</form>
</section>

<footer data-src="templates/footer.html" data-type="text/html"></footer>

<script src="prism.js" id="prism"></script>
<script src="utopia.js"></script>
<script src="components.js"></script>
<script src="code.js"></script>
<script src="vendor/promise.js"></script>

<script>
(function() {
var form = $('form'), code = $('code', form),
    languages = components.languages,
    plugins = components.plugins,
    highlightCode = function() { Prism.highlightElement(code); };
var ENTER_KEY = 13;
var id;

for (id in languages) {
	if (id == 'meta') {
		continue;
	}

	var name = languages[id].title || languages[id];

	$u.element.create('label', {
		attributes: {
			'data-id': id
		},
		contents: [
			{
				tag: 'input',
				properties: {
					type: 'radio',
					name: 'language',
					value: id,
					onclick: function () {
						var lang = this.value;
						code.className = 'language-' + lang;
						code.textContent = code.textContent;

						// loadLanguage() returns a promise, so we use highlightCode()
						// as resolve callback. The promise will be immediately
						// resolved if there is nothing to load.
						loadLanguage(lang).then(highlightCode);
					}
				}
			}, name
		],
		inside: '#language'
	});
}

for (id in plugins) {
	if (id == 'meta') {
		continue;
	}

	var name = plugins[id].title || plugins[id];

	$u.element.create('label', {
		attributes: {
			'data-id': id
		},
		contents: [
			{
				tag: 'input',
				properties: {
					type: 'checkbox',
					name: 'plugins',
					value: id,
					onchange: function () {
						var plugin = this.value;

						if (this.checked){
							loadPlugin(plugin).then(highlightCode);
						}else{
							reloadPlugins().then(highlightCode);
						}
					}
				}
			}, name
		],
		inside: '#plugins'
	});
}

// update <pre> class either on inputs blur or if Enter key was pressed
form.codeClass.onblur =
	form.codeClass.onkeypress = function (event) {
		if (event.type === 'blur' || event.which === ENTER_KEY){
			code.parentElement.className = this.value + ' language-' + form.language.value;
			highlightCode();
		}
	};

// update <pre> attributes either on inputs blur or if Enter key was pressed
form.codeAttributes.onblur =
	form.codeAttributes.onkeypress = function (event) {
		if (event.type === 'blur' || event.which === ENTER_KEY){
			// remove existing attributes
			var pre = code.parentElement;
			var attributes = pre.getAttribute('data-attributes');

			if (attributes){
				attributes.split(',').forEach(function (attr) {
					pre.removeAttribute(attr);
				});
			}

			// add user entered attributes
			var value;
			if (value = this.value.trim()){
				attributes = [];
				this.value.split(' ').forEach(function (keyValue) {
					var attr = keyValue.split('=');

					if (attr === 'data-attributes'){
						return;
					}

					try{
						pre.setAttribute(attr[0], attr[1] || '');
						attributes.push(attr[0]);
					}catch(e){
						// catch the situations when user entered attribute name which starts from numbers
					}

				});

				pre.setAttribute('data-attributes', attributes.join(','));
			}

			highlightCode();
		}
	}



/**
 * Loads a language, including all dependencies
 *
 * @param {string} lang the language to load
 * @type {Promise} the promise which resolves as soon as everything is loaded
 */
function loadLanguage (lang)
{
	// at first we need to fetch all dependencies for the main language
	// Note: we need to do this, even if the main language already is loaded (just to be sure..)
	//
	// We load an array of all dependencies and call recursively this function on each entry
	//
	// dependencies is now an (possibly empty) array of loading-promises
	var dependencies = getDependenciesOfLanguage(lang).map(loadLanguage);

	// We create a promise, which will resolve, as soon as all dependencies are loaded.
	// They need to be fully loaded because the main language may extend them.
	return Promise.all(dependencies)
		.then(function () {

			// If the main language itself isn't already loaded, load it now
			// and return the newly created promise (we chain the promises).
			// If the language is already loaded, just do nothing - the next .then()
			// will immediately be called
			if (!Prism.languages[lang]) {
				return new Promise(function (resolve) {
					$u.script('components/prism-' + lang + '.js', resolve);
				});
			}
		});
}

/**
 * Loads a plugin including it css file
 *
 * @param  {string} plugin the plugin to load
 * @type {Promise} the promise which resolves as soon as plugin is loaded
 */
function loadPlugin (plugin)
{
	if (!components.plugins[plugin]){
		return;
	}

	var pluginPath = components.plugins.meta.path;

	return new Promise(function (resolve) {
		pluginPath = pluginPath.replace(/{id}/g, plugin);

		$u.script(pluginPath + '.js', function() {
			this.setAttribute('data-type', 'plugin');

			var style = document.createElement('link');
			style.setAttribute('rel', 'stylesheet');
			style.setAttribute('href', pluginPath + '.css')
			style.setAttribute('data-type', 'plugin');
			document.body.appendChild(style);

			resolve();
		});
	});
}

/**
 * Reload all selected plugins and prism core
 * You can hit me for such solution, but there are no other way :)
 */
function reloadPlugins ()
{
	var selectedPlugins = $$('input[type="checkbox"]:checked', document.forms[0]);
	selectedPlugins = selectedPlugins.map(function(plugin) { return plugin.value });

	$('#prism').remove();
	$$('script[data-type="plugin"],link[data-type="plugin"]').forEach(function (script) {
		script.remove();
	});

	// firstly loads prism core, after it - all selected plugins
	return new Promise(function (resolve) {
		$u.script('prism.js', function () {
			this.setAttribute('id', 'prism');

			Promise.all(
				selectedPlugins.map(function (plugin) {
					return loadPlugin(plugin);
				})
			).then(resolve);
		});
	});

}

/**
 * Returns all dependencies (as identifiers) of a specific language
 *
 * @param {string} lang
 * @returns {Array.<string>} the list of dependencies. Empty if the language has none.
 */
function getDependenciesOfLanguage (lang)
{
	if (!components.languages[lang] || !components.languages[lang].require)
	{
		return [];
	}

	return ($u.type(components.languages[lang].require) === "array")
		? components.languages[lang].require
		: [components.languages[lang].require];
}


var radios = $$('input[name=language]');
radios[0].checked = true;
radios[0].onclick();

var textarea = $('textarea', form);
var savedCode;
	if (savedCode = window.localStorage ? window.localStorage.getItem('test_code') : null){
		textarea.textContent = savedCode;
	}

(textarea.onblur = function() {
	if (window.localStorage){
		localStorage.setItem('test_code', this.value);
	}
},
textarea.oninput = function() {
	code.textContent = this.value || '';
	highlightCode();
}).call(textarea);

})();

</script>

</body>
</html>
